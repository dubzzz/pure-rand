language: node_js
node_js:
  - "14"
  - "12"
  - "10"
cache:
  directories:
    - node_modules
if: branch = master OR branch =~ ^next- OR branch =~ ^fix-v\d+\. OR tag =~ ^v\d+\.
script:
  - yarn format:check
  - yarn build:prod
  - yarn test
after_success:
  - yarn coverage
stages:
  - test
  - deploy
jobs:
  include:
    - stage: test
      env: STEP=LEGACY
      script:
        - yarn build:prod
        - nvm install 0.12
        - node test/legacy/main.js
    - stage: test
      env: STEP=COMMONJS_ESM
      script:
        - PROJECT_ROOT_PATH="$(pwd)"
        - yarn build:prod
        - yarn link
        # Node 8 does not understand ES modules
        - nvm install 8
        - cd ${PROJECT_ROOT_PATH}
        - cd test/esm
        - node --version
        - sh run.sh
        # Node 12 requires a flag to support ES modules but can understand them
        - nvm install 12
        - cd ${PROJECT_ROOT_PATH}
        - cd test/esm
        - node --version
        - sh run.sh
        # Node >=13.2.0 enables support for ES modules by default
        - nvm install 13
        - cd ${PROJECT_ROOT_PATH}
        - cd test/esm
        - node --version
        - sh run.sh
    - stage: deploy
      if: tag =~ ^v\d+\.
      script:
        - yarn build:prod
      deploy:
        provider: npm
        email: npm@dubien.org
        skip_cleanup: true
        api_key:
          secure: lHunqDdos1umal6SvUE6SdOf8DC9BCI4qhumxwf3RXt1E0OqKh2tIfdfBMb+JdTjceb1sRswPg+M0phmU6fRYI81ZjPA7/qzW4V8zy3E/TGbH6TT0Tx2AhPUDgNE1kt2mW3L5T9uHX+CVPsrqNmauQDAtzf4HXJCroQ+QWGwUzVjvEVc/KSeb5MFer1tQoTcjj0bHeFta5e/W0IK2rx6dHI817ctOL8VYoNqZ0iiasPqQo4AeBVouX0WRSXEAti3FN+l5oZ3dLOHbztQqWj0u86j3tH4QJ6ypjx3vd8JTb2ePzSg2OVdP3/MkRHlpehyoCAr+Cwme7FeKJVI748/BmshiFFAYbMZrnUj9sbmJZM/2tkpZh+uDL/FkADv3QIo/O++l30C8fMFScMkujGJuCECJBe/mZYDRJFjcl0BCgsJbk0F9MY2cxfHWssUpa31E3WoPEJa+1/oy6HYlN3wq9KjxrTmbJ87PBexnfSgmzB2QVw0irEjGETBkZvUeDP4LuHx7vHml1TqRvlcFZMrV9tT9CT7ngTB/6J/yey8WOaU4u8uJoBY23xJipgxGnqHk7PmYqV0Laa+Bn+aoSITgzvBYvY0imZCa3+YD3G1/2eBuJ6ztBALjQRWM4uGix0UXaRLzcdVlLlCxSTOD6TW8ZneQX8Ng5fVcv/ZkOdmIV0=
        on:
          tags: true
      repo: dubzzz/pure-rand
